<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Post - AnimePulse Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="assets/js/api.js"></script>
    <script src="assets/js/layout.js"></script>
    <script src="assets/js/create-post.js"></script>
    <link rel="stylesheet" href="assets/css/create-post.css">
    <link rel="stylesheet" href="assets/css/home.css">
</head>

<body class="min-h-screen text-base">
    <div class="background-pattern"></div>
    <div class="noise-overlay"></div>

    <!-- Main Content -->
    <div class="transition-all duration-300 ease-in-out" id="mainContent">

        <div class="p-4 md:p-6 lg:p-8">
            <div class="max-w-7xl mx-auto">
                <h1 class="text-2xl md:text-3xl lg:text-4xl font-bold text-gray-900 mb-6 md:mb-8">Create New Post</h1>

                <div class="dashboard-card p-6 md:p-8">
                    <form id="createPostForm" class="space-y-6">
                        <div>
                            <label class="block text-sm font-bold text-gray-900 mb-2">Post Title</label>
                            <input id="cpTitle" type="text" class="form-input w-full" placeholder="Enter post title">
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-gray-900 mb-2">Category</label>
                            <select id="cpCategory" class="form-input w-full">
                                <option value="" disabled selected>Select a Category</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-gray-900 mb-2">Featured Image</label>
                            <div id="uploadArea"
                                class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-primary cursor-pointer transition-colors relative overflow-hidden">
                                <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                                <p class="text-gray-600">Click to upload image</p>
                                <input type="file" id="cpFileInput" class="hidden" accept="image/*">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-gray-900 mb-2">Content</label>
                            <textarea id="cpContent" class="form-input w-full h-64"
                                placeholder="Write your post content here..."></textarea>
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-gray-900 mb-2">Tags</label>
                            <input id="cpTags" type="text" class="form-input w-full"
                                placeholder="Enter tags separated by commas">
                        </div>

                        <div class="flex flex-col sm:flex-row gap-4">
                            <button id="cpPublish" type="button"
                                class="flex-1 px-6 py-3 bg-primary text-white rounded-lg font-bold hover:bg-primary-dark">
                                <i class="fas fa-save mr-2"></i>Publish
                            </button>
                            <button id="cpDraft" type="button"
                                class="flex-1 px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-bold hover:bg-gray-300">
                                <i class="fas fa-file-save mr-2"></i>Draft
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <script>
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const mobileMenuToggle = document.getElementById('mobileMenuToggle');
            const mainContent = document.getElementById('mainContent');
            const sidebarOverlay = document.getElementById('sidebarOverlay');

            function updateSidebarState() {
                if (window.innerWidth >= 1025) {
                    sidebar.classList.remove('mobile-open');
                    sidebar.classList.remove('collapsed');
                    sidebar.style.display = 'block';
                    mainContent.style.marginLeft = 'var(--sidebar-width)';
                    mainContent.style.width = 'calc(100% - var(--sidebar-width))';
                    sidebarOverlay.classList.remove('active');
                } else {
                    sidebar.classList.remove('mobile-open');
                    sidebar.style.display = 'none';
                    mainContent.style.marginLeft = '0';
                    mainContent.style.width = '100%';
                    sidebarOverlay.classList.remove('active');
                }
            }

            sidebarToggle.addEventListener('click', function () {
                if (window.innerWidth >= 1025) {
                    sidebar.classList.toggle('collapsed');
                    const isCollapsed = sidebar.classList.contains('collapsed');
                    mainContent.style.marginLeft = isCollapsed ? 'var(--sidebar-collapsed-width)' : 'var(--sidebar-width)';
                    mainContent.style.width = isCollapsed ? 'calc(100% - var(--sidebar-collapsed-width))' : 'calc(100% - var(--sidebar-width))';
                }
            });

            mobileMenuToggle.addEventListener('click', function () {
                if (window.innerWidth < 1025) {
                    sidebar.classList.toggle('mobile-open');
                    sidebar.style.display = sidebar.classList.contains('mobile-open') ? 'block' : 'none';
                    sidebarOverlay.classList.toggle('active');
                }
            });

            sidebarOverlay.addEventListener('click', function () {
                if (window.innerWidth < 1025) {
                    sidebar.classList.remove('mobile-open');
                    sidebar.style.display = 'none';
                    sidebarOverlay.classList.remove('active');
                }
            });

            window.addEventListener('resize', updateSidebarState);
            updateSidebarState();
            (async function init() {
                // Initialize Categories
                try {
                    const cats = await API.apiGet('/categories');
                    const catSelect = document.getElementById('cpCategory');
                    // Keep the default option
                    const defaultOption = '<option value="" disabled selected>Select a Category</option>';
                    catSelect.innerHTML = defaultOption + cats.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                } catch (e) {
                    console.error('Failed to load categories', e);
                }

                const form = document.getElementById('createPostForm');
                const publish = document.getElementById('cpPublish');
                const draft = document.getElementById('cpDraft');

                // File Upload Logic
                const uploadArea = document.getElementById('uploadArea');
                const fileInput = document.getElementById('cpFileInput');
                let selectedFileBase64 = null;

                if (uploadArea && fileInput) {
                    uploadArea.addEventListener('click', (e) => {
                        if (e.target !== fileInput) {
                            fileInput.click();
                        }
                    });

                    fileInput.addEventListener('change', (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = (re) => {
                                selectedFileBase64 = re.target.result;
                                // Clear previous content except input
                                const content = Array.from(uploadArea.children).filter(el => el !== fileInput);
                                content.forEach(el => el.remove());

                                // Add preview
                                const img = document.createElement('img');
                                img.src = selectedFileBase64;
                                img.className = "max-h-64 mx-auto rounded-lg object-contain";
                                uploadArea.insertBefore(img, fileInput);

                                const p = document.createElement('p');
                                p.className = "text-sm text-gray-500 mt-2";
                                p.innerText = "Click to change";
                                uploadArea.insertBefore(p, fileInput);
                            };
                            reader.readAsDataURL(file);
                        }
                    });
                }

                function gather(status) {
                    return {
                        title: document.getElementById('cpTitle').value,
                        content: document.getElementById('cpContent').value,
                        category_id: Number(document.getElementById('cpCategory').value) || null,
                        tags: document.getElementById('cpTags').value,
                        status
                    };
                }

                async function submit(status) {
                    const publishBtnText = publish.innerHTML;
                    const draftBtnText = draft.innerHTML;

                    try {
                        // Loading state
                        publish.disabled = true;
                        draft.disabled = true;
                        publish.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Publishing...';
                        draft.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';

                        let imageUrl = null;
                        if (selectedFileBase64) {
                            const uploadRes = await API.apiPost('/uploads', { data_url: selectedFileBase64 });
                            imageUrl = uploadRes.url;
                        }

                        const payload = gather(status);
                        if (imageUrl) payload.featured_image_url = imageUrl;

                        await API.apiPost('/posts', payload);
                        alert('Saved successfully');
                        window.location.href = 'manage-posts.html';
                    } catch (e) {
                        alert('Save failed: ' + (e.message || 'Unknown error'));
                        console.error(e);
                    } finally {
                        publish.disabled = false;
                        draft.disabled = false;
                        publish.innerHTML = publishBtnText;
                        draft.innerHTML = draftBtnText;
                    }
                }

                publish && publish.addEventListener('click', () => submit('published'));
                draft && draft.addEventListener('click', () => submit('draft'));
            })();
        </script>
</body>

</html>